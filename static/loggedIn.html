<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- icons are 'brain', 'ruler', 'sync', 'newspaper' and 'cheerleader' from http://thenounproject.com/ -->
    <!-- svg editor is http://code.google.com/p/svg-edit/ -->
    <!-- most of the other stuff from http://unhosted.org/ -->
    <meta charset="utf-8">
    <title>Libre Docs</title>
    <link rel="icon" type="image/png" href="/icons/noun_project_826.ico"/>
    <script src="beFree/pimp.js"></script>
    <script src="http://unhosted.nodejitsu.com/require.js" data-main="http://unhosted.nodejitsu.com/main"></script>
    <script>
      function displayLogin() {
        document.getElementById('header').innerHTML = 'Libre Docs - '
          + localStorage.getItem('LibreDocsUserAddress')
          + ' <input type="submit" value="logout" onclick="localStorage.clear();location=\'\';">';
      }
      function getUserNameForIrisCouch(userAddress, userNameTry) {
        return userAddress.replace(/-/g, '--').replace(/@/g, '-at-').replace(/./g, '-dot-')+(userNameTry?'-'+userNameTry:'');
      }
      function enroll(sessionObj, userNameTry) {
        var userName = getUserNameForIrisCouch(sessionObj.userAddress, userNameTry);
        pimper.provision(userName, sessionObj.firstName, sessionObj.lastName, sessionObj.userAddress, sessionObj.token, function(result) {
          if(result=='taken') {
            console.log('Username '+userName+'is taken! :( trying a different one');
            enroll(sessionObj, (userNameTry?userNameTry:0)+1);
          } else if(result=='ok') {
            ping(userName, proxy, 0, function() {
              pimper.squat(userName+'.iriscouch.com', userName, password, assertion, function() {
                pimper.populate(userName+'.iriscouch.com', userName, password, assertion, proxy, function() {
                  alert('done');
                });
              });
            });
          } else {
            alert('Oops! Error code '+result);
          }
        });
      }
      function getToken(sessionObj, err, cb) {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', sessionObj.attr.browseridAccess, true);
        xhr.onreadystatechange = function() {
          if(xhr.readyState == 4) {
            if(xhr.status == 200) {
              cb(xhr.responseText);
            } else {
              err(xhr.responseText);
            }
          }
        }
        xhr.send(JSON.stringify({
          audience: sessionObj.audience,
          assertion: sessionObj.assertion
        }));
      }
      function checkWebfinger(sessionObj) {
        if(sessionObj.state == 'wf1') {
          require(['webfinger'], function(webfinger) {
            webfinger.getAttributes(sessionObj.userAddress, {}, function() {}, function(attr) {
              if(attr) {
                sessionObj.attr = attr;
                sessionObj.state = 'connecting';
                localStorage.setItem('sessionObj', JSON.stringify(sessionObj));
                checkForLogin();
              } else {
                sessionObj.state = 'needed';
                localStorage.setItem('sessionObj', JSON.stringify(sessionObj));
                checkForLogin();
              }
            });
          });
        }
      }
      function checkForLogin() {
        window.addEventListener('storage', function(e) {
          if(e.key == 'LibreDocsUserAddress') {
            displayLogin();
          }
        }, false);
        if(localStorage.getItem('LibreDocsUserAddress')) {
          displayLogin();
        } else {
          var sessionObj = JSON.parse(localStorage.getItem('sessionObj'));
          if(sessionObj) {
            if(sessionObj.state == 'wf1') {
              document.getElementById('header').innerHTML = 'Libre Docs - '+sessionObj.userAddress+' (checking)';
              checkWebfinger(sessionObj);
            } else if(sessionObj.state == 'needed') {
              document.getElementById("3").style.display='block';
              document.getElementById('header').innerHTML = 'Libre Docs - '+sessionObj.userAddress+' (pending)';
            } else if(sessionObj.state == 'agree') {
              document.getElementById("3").style.display='none';
              document.getElementById('header').innerHTML = 'Libre Docs - '+sessionObj.userAddress+' (pending)';
              enroll(sessionObj);
            } else if(sessionObj.state == 'connecting') {
              document.getElementById('header').innerHTML = 'Libre Docs - '+sessionObj.userAddress+' (connecting)';
              getToken(sessionObj, function() {
                sessionObj.state = 'error';
                localStorage.setItem('sessionObj', JSON.stringify(sessionObj));
                checkForLogin();
              }, function(token) {
                sessionObj.token = token;
                sessionObj.state = 'pulling';
                localStorage.setItem('sessionObj', JSON.stringify(sessionObj));
                checkForLogin();
              });
            } else if(sessionObj.state == 'pulling') {
              document.getElementById('header').innerHTML = 'Libre Docs - '+sessionObj.userAddress+' (pulling)';
              localStorage.setItem('sessionObj', JSON.stringify(sessionObj));
            } else if(sessionObj.state == 'error') {
              document.getElementById('header').innerHTML = 'Libre Docs - '+sessionObj.userAddress+' (error)';
              localStorage.setItem('sessionObj', JSON.stringify(sessionObj));
            }
          }
        }
      }
      function agree() {
        var sessionObj = JSON.parse(localStorage.getItem('sessionObj'));
        localStorage.setItem('sessionObj', JSON.stringify({
            state: 'agree',
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            token: sessionObj.token,
            userAddress: sessionObj.userAddress
          })
        );
        checkForLogin();
      }
    </script>
  </head>
  <body onload="checkForLogin();">
      <h2 id="header">Libre Docs</h2>
    <div id="3" style="display:none;"><h2>Please sign up for easy freedom</h2>I, <input id="firstName" placeholder="first name"> <input id="lastName" placeholder="last name">, agree with the Terms of Service of IrisCouch.com. <input type="submit" value="Agree" onclick="agree();">
    <br>
    <br>
    <br>
    <a href="/beFree/advanced.html">or choose for advanced freedom</a>.</div>
      <table><tr><td onclick="window.open('write/');">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" width="100px" height="100px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve">
          <path fill="#000000" d="M97,41.602c0-5.333-2.849-10.279-7.519-13.193c-2.479-10.137-12.043-17.363-23.244-17.363  c-2.695,0-5.326,0.418-7.846,1.246c-3.125-2.951-7.332-4.61-11.823-4.61c-5.188,0-10.109,2.315-13.257,6.145  c-0.698-0.083-1.4-0.125-2.1-0.125c-7.604,0-14.109,4.734-16.121,11.486C8.406,27.376,3.876,33.296,3.876,40.113  c0,2.021,0.416,4.037,1.213,5.907c-0.796,1.871-1.213,3.887-1.213,5.906c0,5.863,3.365,11.158,8.814,13.926  c3.128,2.945,7.415,4.625,11.841,4.625c2.827,0,5.538-0.649,7.97-1.898c3.156,3.456,7.816,5.521,12.716,5.521  c3.055,0,5.968-0.757,8.542-2.205c2.85,2.088,6.253,3.433,9.84,3.873c6.047,6.068,10.688,13.907,10.734,13.989l1.525,2.597  l7.658-5.49l-4.263-12.219c2.401-1.112,4.388-2.931,5.646-5.211c5.231-2.776,8.562-8.09,8.562-13.795  c0-1.279-0.161-2.541-0.479-3.769C95.554,49.024,97,45.37,97,41.602z M81.709,64.877l-0.954,0.436l-0.422,0.961  c-0.885,2.013-2.801,3.484-5.122,3.938l-3.116,0.607l4.064,11.649c-2.221-3.209-5.547-7.592-9.415-11.321l-0.716-0.689l-0.99-0.073  c-2.365-0.175-4.633-0.886-6.625-2.028l7.918-6.258c2.062-1.631,4.841-2.341,5.777-2.09l3.629,0.965l1.363-5.136l-3.63-0.964  c-3.19-0.85-7.758,0.943-10.434,3.057l-8.892,7.025l-0.021-0.02l-1.822,1.355c-2.026,1.51-4.352,2.309-6.962,2.309  c-3.727,0-7.172-1.735-9.172-4.551v-2.924v-1.223v-3.819c0-2.132,0.992-4.168,1.577-4.521l2.969-1.834l-2.88-4.705l-3.045,1.832  c-1.425,0.861-2.527,2.385-3.262,4.093c-0.618-0.57-1.285-1.078-1.982-1.501l-8.907-5.399l-2.853,4.703l8.78,5.399  c2.133,1.293,3.603,4.104,3.603,5.752v1.223v2.316c-2,1.002-3.648,1.535-5.762,1.535c-3.142,0-6.104-1.222-8.232-3.349l-0.305-0.336  l-0.414-0.203c-3.76-1.784-6.088-5.296-6.088-9.164c0-1.609,0.401-3.153,1.184-4.591l0.718-1.316l-0.716-1.315  c-0.782-1.435-1.179-2.979-1.179-4.59c0-4.781,3.54-8.902,8.607-10.021l1.8-0.398l0.316-1.816c0.875-5.028,5.548-8.677,11.113-8.677  c0.907,0,1.819,0.102,2.71,0.304l1.885,0.426l1.04-1.629c2.015-3.158,5.741-5.12,9.723-5.12c2.58,0,5.006,0.797,6.97,2.228  l-2.045,1.908l-0.035-0.038l-1.433,1.336c-1.929,1.476-4.292,2.251-5.193,2.115l-3.899-0.587l-0.817,5.439l3.896,0.586  c0.13,0.02,0.269,0.018,0.402,0.029c-0.629,1.965-0.855,4.06-0.537,5.913l0.897,5.226l5.421-0.932l-0.897-5.225  c-0.338-1.969,0.657-4.978,2.091-6.313l2.254-2.104c0.31-0.245,0.604-0.493,0.873-0.743l4.316-4.027  c2.345-0.956,4.834-1.447,7.402-1.447c9.009,0,16.623,5.942,18.106,14.129l0.24,1.328l1.196,0.622  c3.527,1.834,5.72,5.274,5.72,8.978c0,1.94-0.591,3.786-1.677,5.392l-0.854-0.854h0.001l-3.563-3.563  c-1.549-1.548-3.133-4.974-3.393-7.33l-0.588-5.353l-5.279,0.58l0.588,5.353c0.168,1.535,0.688,3.273,1.399,4.947  c-0.353-0.043-0.705-0.09-1.044-0.106L65.14,40.101l-0.253,5.306l11.953,0.566c2.446,0.116,6.026,1.574,7.513,3.059l2.834,2.835  l0.103,0.255c0.446,1.125,0.673,2.31,0.673,3.517C87.961,59.578,85.565,63.118,81.709,64.877z"/>
        </svg>
      </td><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td onclick="window.open('draw/');">
        <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="100px" height="100px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve">
          <path d="M100,15.915V0L0,100h15.916v-8.009h4.004V100h10.01v-8.009h4.004V100h10.01v-8.009h4.004V100h10.01v-8.009h4.004V100h10.011 v-8.009h4.004V100h10.01v-8.009h4.004V100H100V89.989h-8.009v-4.004H100v-10.01h-8.009v-4.004H100V61.961h-8.009v-4.004H100v-10.01 h-8.009v-4.004H100v-10.01h-8.009v-4.004H100v-10.01h-8.009v-4.004H100z M85.986,85.985H33.833l52.153-52.152V85.985z"/>
        </svg>
      </td><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td onclick="window.open('sync/'+(localStorage.getItem('LibreDocsUserAddress')?'':'signIn.html'));">
        <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="100px" height="64px" viewBox="0 0 100 64" enable-background="new 0 0 100 64" xml:space="preserve">
          <path d="M84.604,10l-13-10v6h-43C19.343,6,11.05,9.603,5.852,15.885c-3.605,4.357-7.431,12.034-5.178,23.863l0.005-0.001	C1.029,41.599,2.65,43,4.604,43c2.209,0,4-1.791,4-4c0-0.256-0.029-0.505-0.075-0.747l0.005-0.001 c-1.323-6.945-0.119-12.916,3.481-17.267C15.688,16.546,21.734,14,28.604,14h43v6L84.604,10z"/>
          <path d="M15.396,54l13,10v-6h43c9.261,0,17.554-3.603,22.752-9.885c3.605-4.357,7.431-12.034,5.178-23.863l-0.005,0.001 C98.971,22.401,97.35,21,95.396,21c-2.209,0-4,1.791-4,4c0,0.256,0.029,0.505,0.075,0.747l-0.005,0.001 c1.323,6.945,0.119,12.916-3.481,17.267C84.312,47.454,78.266,50,71.396,50h-43v-6L15.396,54z"/>
        </svg>
      </td><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td onclick="window.open('publish/'+(localStorage.getItem('LibreDocsUserAddress')?'':'signIn.html'));">
        <svg version="1.0" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="100px" height="92.325px" viewBox="0 0 100 92.325" enable-background="new 0 0 100 92.325" xml:space="preserve">
          <path d="M96.079,41.418c-2.146,0-4.291,0-6.437,0V18.189L50,44.445L10.357,18.189v23.229c-2.145,0-4.291,0-6.436,0 c-5.229,0-5.229,8.109,0,8.109c2.146,0,4.291,0,6.436,0v21.175L50,92.325l39.643-21.623V49.527c2.146,0,4.291,0,6.437,0 C101.307,49.527,101.307,41.418,96.079,41.418z"/>
          <circle cx="50" cy="14.929" r="14.93"/>
        </svg>
      </td><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td onclick="window.open('beFree/'+(localStorage.getItem('LibreDocsUserAddress')?'':''));">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" width="100px" height="100px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve">
        <g>
          <g>
            <g>
              <path d="M49.41,43.347c-4.013,0-7.135-3.119-7.135-7.13c0-3.791,3.123-6.912,7.135-6.912c3.785,0,6.908,3.121,6.908,6.912     C56.316,40.228,53.195,43.347,49.41,43.347z"/>
              <path d="M36.97,83.348c-0.002,0.002-0.004,0.008-0.005,0.012c0.727,0.441,1.624,0.986,2.067,1.257     c-0.003-0.607-0.014-2.138-0.021-3.267C37.959,81.844,37.29,82.785,36.97,83.348z M63.698,45.265l4.727-14.342     c1.034-3.143,0.442-4.824-1.979-5.622c-2.399-0.79-4.049,0.292-5.045,3.309l-5.161,15.661c-0.044,0.13-0.036,0.259-0.009,0.384     l-13.437,0.202L37.47,28.719c-0.994-3.016-2.645-4.098-5.046-3.307c-2.421,0.797-3.014,2.479-1.979,5.622     c0,0,3.837,11.646,4.847,14.709c0.005,0.07,0.016,0.141,0.041,0.209l5.125,14.094l-8.945,17.705     c-0.117,0.229-0.105,0.506,0.031,0.728c0.137,0.22,0.379,0.353,0.638,0.35l7.58-0.038l0.017,7.149l-8.087-4.713     c-3.42-1.945-5.266,0.541-5.875,1.609c-0.549,0.964-1.704,3.987,1.505,5.814c2.564,1.461,11.068,6.062,13.955,7.617     c0.301,0.186,1.03,0.504,1.03,0.504c0.644,0.222,1.26,0.27,1.642,0.27c0.838,0,3.455-0.277,4.216-2.714     c0.004,0.002,0.008,0.003,0.011,0.006c0.08-0.335,0.136-0.737,0.136-1.153l-0.055-14.508l2.215-0.007v7.286     c-0.44-0.243-0.966-0.555-1.401-0.797l-0.02,8.025c0,0.57-0.074,1.068-0.198,1.508c1.459,0.762,2.676,1.394,3.336,1.735     c0.942,0.597,2.031,0.724,2.59,0.724c1.229,0,4.306-0.373,4.306-4.308c0,0,0.011-8.015,0.011-14.153l7.914,0.023     c0.258-0.003,0.493-0.139,0.626-0.357c0.132-0.221,0.142-0.492,0.023-0.721l-9.14-17.826l5.138-14.26     C63.693,45.455,63.702,45.359,63.698,45.265z"/>
            </g>
            <g>
              <path d="M39.709,10.43c0-3.068-2.496-5.563-5.563-5.563c-0.732,0-1.43,0.146-2.07,0.404c-1.532-1.945-3.902-3.2-6.563-3.2     c-2.721,0-5.135,1.313-6.662,3.333c-2.803,0.285-4.997,2.657-4.997,5.534c0,0.251,0.026,0.497,0.059,0.74     c-1.272,1.021-2.09,2.585-2.09,4.338c0,3.068,2.496,5.563,5.563,5.563c0.113,0,0.225-0.01,0.337-0.017     c1.211,3.125,4.241,5.351,7.789,5.351c2.558,0,4.85-1.158,6.383-2.975c0.24,0.025,0.482,0.042,0.728,0.042     c3.831,0,6.947-3.117,6.947-6.949c0-1.23-0.326-2.386-0.889-3.39C39.326,12.732,39.709,11.625,39.709,10.43z"/>
            </g>
          </g>
          <g>
            <path d="M59.291,10.429c0-3.068,2.496-5.563,5.562-5.563c0.731,0,1.432,0.146,2.069,0.403c1.533-1.944,3.902-3.199,6.563-3.199    c2.722,0,5.136,1.312,6.662,3.333c2.804,0.284,4.996,2.657,4.996,5.534c0,0.251-0.024,0.496-0.059,0.739    c1.271,1.021,2.09,2.585,2.09,4.339c0,3.067-2.496,5.562-5.562,5.562c-0.113,0-0.227-0.01-0.338-0.017    c-1.211,3.125-4.24,5.351-7.789,5.351c-2.557,0-4.85-1.158-6.383-2.975c-0.239,0.025-0.481,0.042-0.729,0.042    c-3.83,0-6.947-3.117-6.947-6.949c0-1.23,0.326-2.386,0.891-3.39C59.674,12.732,59.291,11.625,59.291,10.429z"/>
          </g>
        </g>
        </svg>
      </td></tr><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;</td></tr><tr>
      <td align="center" onclick="window.open('write/');">Write</td>
      <td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
      <td align="center" onclick="window.open('draw/');">Draw</td>
      <td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
     <td align="center" onclick="window.open('sync/'+(localStorage.getItem('LibreDocsUserAddress')?'':'signIn.html'));">Sync</td>
      <td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
        <td align="center" onclick="window.open('publish/'+(localStorage.getItem('LibreDocsUserAddress')?'':'signIn.html'));">Publish</td>
      <td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
        <td align="center" onclick="window.open('beFree/'+(localStorage.getItem('LibreDocsUserAddress')?'':''));">Be free</td>
      </tr></table>
  </body>
</html>
